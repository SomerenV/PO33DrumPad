<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PO-33 Drum Pad</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ryanoasis/nerd-fonts@master/patched-fonts/3270/Regular/3270-Regular.css">

<style>
* { box-sizing:border-box; font-family:"3270 Nerd Font", monospace; }

body {
  background:#0d0d0d;
  color:#e0e0e0;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px;
}

h1 { font-size:48px; margin-bottom:12px; }

.buttons, .controls {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:center;
  margin-bottom:12px;
}

button {
  background:#111;
  color:#e0e0e0;
  border:1px solid #444;
  padding:8px 14px;
  font-size:15px;
  font-weight:bold;
  cursor:pointer;
}

button.selected {
  background:#fff;
  color:#000;
}

.grid {
  display:grid;
  grid-template-columns:repeat(4,200px);
  gap:10px;
  margin-bottom:16px;
}

.pad {
  width:200px;
  height:200px;
  background:#111;
  border:1px dashed #444;
  position:relative;
  cursor:pointer;
  overflow:hidden;
}

.pad.loaded { border-style:solid; background:#181818; }
.pad.playing { background:#00ff66; color:#000; }
.pad.countdown { background:#ff3333; color:#000; }

.pad-number {
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 14px;
  opacity: 0.5;
  pointer-events: none;
}

canvas {
  position:absolute;
  inset:0;
  opacity:0.25;
}

.rate {
  position:absolute;
  top:6px;
  left:6px;
  font-size:14px;
}

.label {
  position:absolute;
  bottom:6px;
  left:6px;
  right:6px;
  font-size:18px;
  white-space:pre-line;
  text-align:center;
}

input {
  background:#111;
  color:#fff;
  border:1px solid #444;
  font-size:18px;
  padding:4px 8px;
  width:90px;
  text-align:center;
}

.help {
  margin-top: 18px;
  max-width: 860px;
  opacity: 0.75;
  font-size: 20px;
}

.help ul {
  list-style: "• ";
  padding-left: 18px;
}

.help li {
  margin: 4px 0;
}

.help b {
  color: #fff;
  font-weight: bold;
}

</style>
</head>

<body>

<h1>PO-33 DRUM PAD</h1>

<div class="buttons" id="genreButtons"></div>
<div class="grid" id="grid"></div>

<div class="controls">
  <button id="playAll">Play All</button>
  <button id="play1">Play 1–8</button>
  <button id="play2">Play 9–16</button>
  <button id="stop">Stop</button>

  <button id="saveKit">Save Kit</button>
  <button id="loadKit">Load Kit</button>

  <label>Cutoff (ms)
    <input id="cutoffInput" type="number" value="0" min="0">
  </label>

  <label>Gap (ms)
    <input id="gapInput" type="number" value="50" min="0">
  </label>
</div>

<script>
/* ---------- AUDIO ---------- */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const grid = document.getElementById("grid");
const cutoffInput = document.getElementById("cutoffInput");
const gapInput = document.getElementById("gapInput");

const pads = [];
const rates = [1,2,3,4];
let sequenceId = 0;
const activeSources = new Set();

/* ---------- GENRES ---------- */
const layouts = {
  dnb:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","Kick","Kick Alt","Tom Low","Tom Mid","Tom High","Perc","Perc Alt","FX"],
  techno:["Crash","Ride","Open Hat","Noise","Closed Hat","Clap","Snare","Rim","Kick","Kick Sub","Kick Dist","Tom","Perc","Metal","FX","FX"],
  lofi:["Vinyl","Texture","Open Hat","FX","Soft Hat","Clap","Snare","Rim","Soft Kick","Low Kick","Tom","Tom","Perc","Shaker","Chord","Vocal"],
  jungle:["Crash","Ride","Open Hat","FX","Closed Hat","Snare","Ghost","Rim","Kick","Kick Alt","Tom Low","Tom Mid","Tom High","Amen","Perc","FX"],
  ambient:["Pad1","Pad2","Pad3","FX","Soft Hat","Bell","Snare","Rim","Kick","Kick Low","Tom","Tom","Texture","Texture","FX","FX"],
  trap:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","808","Kick Alt","Tom","Tom","Hi Tom","Perc","FX","Vocal"],
  breakbeat:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Alt Sn","Kick","Kick Alt","Tom","Tom","Hi Tom","Perc","FX","FX"],
  hiphop:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","Kick","Low Kick","Tom","Tom","Perc","Perc2","FX","Vocal"],
  house:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","Kick","Sub","Alt Kick","Tom","Perc","Hi Tom","FX","FX"]
};

/* ---------- PAD ---------- */
function createPad(i){
  const el=document.createElement("div");
  el.className="pad";

  const canvas=document.createElement("canvas");
  canvas.width=200; canvas.height=200;
  el.appendChild(canvas);

  const rateEl=document.createElement("div");
  rateEl.className="rate"; el.appendChild(rateEl);

  const numEl=document.createElement("div");
  numEl.className="pad-number"; numEl.textContent=i+1;
  el.appendChild(numEl);

  const label=document.createElement("div");
  label.className="label"; el.appendChild(label);

  grid.appendChild(el);

  pads[i]={
    buffer:null, duration:0, rate:1,
    el, canvas, rateEl, label,
    name:"", filename:""
  };

  el.ondragover=e=>e.preventDefault();
  el.ondrop=e=>{ e.preventDefault(); loadSample(e.dataTransfer.files[0],i); };

  if ("ontouchstart" in window) addTouchControls(el,i);
  else addMouseControls(el,i);
}

/* ---------- SAMPLE ---------- */
async function loadSample(file,i){
  if(!file) return;
  const buf=await audioCtx.decodeAudioData(await file.arrayBuffer());
  Object.assign(pads[i],{
    buffer:buf,
    duration:buf.duration,
    filename:file.name.replace(/\..+$/,"")
  });
  pads[i].el.classList.add("loaded");
  drawWaveform(pads[i]);
  updateLabel(i);
  updateDuration();
}

/* ---------- WAVEFORM ---------- */
function drawWaveform(p){
  const ctx=p.canvas.getContext("2d");
  ctx.clearRect(0,0,200,200);
  const data=p.buffer.getChannelData(0);
  ctx.strokeStyle="#fff";
  ctx.beginPath();
  for(let x=0;x<200;x++){
    const i=Math.floor(x/data.length*data.length);
    ctx.lineTo(x,(1-data[i])*100);
  }
  ctx.stroke();
}

/* ---------- LABEL ---------- */
function updateLabel(i){
  const p=pads[i];
  p.rateEl.textContent=p.rate+"x";
  p.label.textContent=
    p.name+(p.buffer?`\n${p.filename}\n${p.duration.toFixed(2)}s`:"");
}

/* ---------- RATE ---------- */
function cycleRate(i){
  const p=pads[i];
  p.rate=rates[(rates.indexOf(p.rate)+1)%rates.length];
  updateLabel(i); updateDuration();
}

/* ---------- CONTROLS ---------- */
function addMouseControls(el,i){
  let t=null, lp=false;
  el.addEventListener("mousedown",()=>{
    lp=false;
    t=setTimeout(()=>{lp=true; openFile(i);},600);
  });
  el.addEventListener("mouseup",()=>{
    clearTimeout(t);
    if(!lp) playPad(i);
  });
  el.addEventListener("mouseleave",()=>clearTimeout(t));
  el.addEventListener("contextmenu",e=>{
    e.preventDefault(); cycleRate(i);
  });
}

function addTouchControls(el,i){
  let t=null,last=0;
  el.addEventListener("touchstart",e=>{
    e.preventDefault();
    t=setTimeout(()=>openFile(i),600);
  },{passive:false});
  el.addEventListener("touchend",e=>{
    e.preventDefault(); clearTimeout(t);
    const now=Date.now();
    if(now-last<300) cycleRate(i);
    else playPad(i);
    last=now;
  },{passive:false});
}

/* ---------- FILE ---------- */
function openFile(i){
  const input=document.createElement("input");
  input.type="file"; input.accept="audio/*";
  input.onchange=e=>loadSample(e.target.files[0],i);
  input.click();
}

/* ---------- PLAY ---------- */
function playPad(i){
  const p=pads[i];
  if(!p.buffer) return;
  const src=audioCtx.createBufferSource();
  src.buffer=p.buffer;
  src.playbackRate.value=p.rate;
  src.connect(audioCtx.destination);
  activeSources.add(src);

  const cutoff=+cutoffInput.value/1000;
  const dur=cutoff>0?Math.min(cutoff,p.buffer.duration/p.rate):p.buffer.duration/p.rate;
  src.start();
  src.stop(audioCtx.currentTime+dur);
  src.onended=()=>activeSources.delete(src);

  p.el.classList.add("playing");
  setTimeout(()=>p.el.classList.remove("playing"),100);
}

/* ---------- DURATION ---------- */
function updateDuration(){
  let t=0;
  const gap=+gapInput.value/1000;
  const cutoff=+cutoffInput.value/1000;
  pads.forEach(p=>{
    if(!p.buffer) return;
    const d=cutoff>0?Math.min(cutoff,p.buffer.duration/p.rate):p.buffer.duration/p.rate;
    t+=d+gap;
  });
  document.getElementById("playAll").textContent=`Play All (${t.toFixed(2)}s)`;
}

/* ---------- SAVE / LOAD ---------- */
function audioBufferToWav(buffer){
  const num=buffer.numberOfChannels;
  const len=buffer.length*num*2+44;
  const v=new DataView(new ArrayBuffer(len));
  let o=0;
  const w=s=>{for(let i=0;i<s.length;i++)v.setUint8(o++,s.charCodeAt(i));};
  w("RIFF"); v.setUint32(o,len-8,true); o+=4;
  w("WAVEfmt "); v.setUint32(o,16,true); o+=4;
  v.setUint16(o,1,true); o+=2;
  v.setUint16(o,num,true); o+=2;
  v.setUint32(o,buffer.sampleRate,true); o+=4;
  v.setUint32(o,buffer.sampleRate*num*2,true); o+=4;
  v.setUint16(o,num*2,true); o+=2;
  v.setUint16(o,16,true); o+=2;
  w("data"); v.setUint32(o,buffer.length*num*2,true); o+=4;
  for(let i=0;i<buffer.length;i++)
    for(let c=0;c<num;c++){
      let s=Math.max(-1,Math.min(1,buffer.getChannelData(c)[i]));
      v.setInt16(o,s*0x7fff,true); o+=2;
    }
  return v.buffer;
}

async function audioToBase64(buffer){
  const bytes=new Uint8Array(audioBufferToWav(buffer));
  let bin="",chunk=0x8000;
  for(let i=0;i<bytes.length;i+=chunk)
    bin+=String.fromCharCode(...bytes.subarray(i,i+chunk));
  return btoa(bin);
}

async function base64ToAudio(b64){
  const bin=atob(b64);
  const u=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++)u[i]=bin.charCodeAt(i);
  return audioCtx.decodeAudioData(u.buffer);
}

document.getElementById("saveKit").onclick=async()=>{
  const kit={cutoff:cutoffInput.value,gap:gapInput.value,pads:[]};
  for(const p of pads){
    if(!p.buffer){ kit.pads.push(null); continue; }
    kit.pads.push({
      role:p.name,
      filename:p.filename,
      rate:p.rate,
      audio:await audioToBase64(p.buffer)
    });
  }
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(kit)],{type:"application/json"}));
  a.download="po33-kit.json";
  a.click();
};

document.getElementById("loadKit").onclick=()=>{
  const i=document.createElement("input");
  i.type="file"; i.accept=".json";
  i.onchange=async e=>{
    const kit=JSON.parse(await e.target.files[0].text());
    cutoffInput.value=kit.cutoff;
    gapInput.value=kit.gap;
    for(let j=0;j<pads.length;j++){
      const d=kit.pads[j];
      if(!d) continue;
      const b=await base64ToAudio(d.audio);
      Object.assign(pads[j],{
        buffer:b,
        duration:b.duration,
        rate:d.rate,
        name:d.role,
        filename:d.filename||""
      });
      pads[j].el.classList.add("loaded");
      drawWaveform(pads[j]);
      updateLabel(j);
    }
    updateDuration();
  };
  i.click();
};

/* ---------- GENRE BUTTONS ---------- */
const gb=document.getElementById("genreButtons");
Object.keys(layouts).forEach(g=>{
  const b=document.createElement("button");
  b.textContent=g.toUpperCase();
  b.onclick=()=>{
    gb.querySelectorAll("button").forEach(x=>x.classList.remove("selected"));
    b.classList.add("selected");
    layouts[g].forEach((n,i)=>{pads[i].name=n; updateLabel(i);});
  };
  gb.appendChild(b);
});

/* ---------- SEQUENCE ---------- */
async function playRange(start, end, singleCountdown = false) {
  const mySeq = ++sequenceId;
  const gap = +gapInput.value / 1000;
  const cutoff = +cutoffInput.value / 1000;

  // ONE countdown for Play All
  if (singleCountdown) {
    for (let c = 3; c > 0; c--) {
      if (mySeq !== sequenceId) return;
      pads[start].el.classList.add("countdown");
      pads[start].label.textContent = `START\n${c}`;
      await new Promise(r => setTimeout(r, 1000));
    }
    pads[start].el.classList.remove("countdown");
    updateLabel(start);
  }

  for (let i = start; i < end; i++) {
    if (mySeq !== sequenceId) return;
    const p = pads[i];
    if (!p.buffer) continue;

    // Per-pad countdown ONLY for split ranges
    if (!singleCountdown) {
      for (let c = 3; c > 0; c--) {
        if (mySeq !== sequenceId) return;
        p.el.classList.add("countdown");
        p.label.textContent = `${p.name}\n${c}`;
        await new Promise(r => setTimeout(r, 1000));
      }
      p.el.classList.remove("countdown");
      updateLabel(i);
    }

    playPad(i);

    const dur = cutoff > 0
      ? Math.min(cutoff, p.buffer.duration / p.rate)
      : p.buffer.duration / p.rate;

    await new Promise(r => setTimeout(r, (dur + gap) * 1000));
  }
}


/* ---------- PLAY BUTTON HANDLERS ---------- */
document.getElementById("playAll").onclick = () =>
  playRange(0, 16, true);     // ONE countdown

document.getElementById("play1").onclick = () =>
  playRange(0, 8, false);     // per-pad countdown

document.getElementById("play2").onclick = () =>
  playRange(8, 16, false);


document.getElementById("stop").onclick = () => {
  sequenceId++;
  activeSources.forEach(src => {
    try { src.stop(); } catch {}
  });
  activeSources.clear();

  pads.forEach((p, i) => {
    p.el.classList.remove("playing", "countdown");
    updateLabel(i);
  });
};


/* ---------- INIT ---------- */
for(let i=0;i<16;i++) createPad(i);
gb.firstChild.click();
updateDuration();
</script>
<div class="help">
  <ul>
    <li><b>Tap</b> pad to play</li>
    <li><b>Long-press or drag & drop</b> pad to load a sample</li>
    <li><b>Right-click or double-tap</b> to change the playbackrate</li>
  </ul>
Use <b>Play All</b> to record the drum samples into a drum slot of the PO-33 (<i>Record + 9-15</i>) using transient detection. Use <b>Play 1-8</b> and <b>Play 9-16</b> if transient detection doesn't work for you. Start with <b>Play 1-8</b> and record them into the 8 melodic slots. Copy each slot to the corresponding drum slot (<i>Write + Sound + 9-16 + 1-8</i>). Then record 9-16 into the 8 melodic slots and copy them into the corresponding drum slot (<i>Write + Sound + 9-16 + 9-16</i>). This takes more effort but works flawlessly if depending on transient detection doesn't work.
<br><br>
You can speed up a sample to mittigate the 40 second limit of the PO-33. Pitch the sample down on the PO-33 to restore its speed. This will impact the quality so use with caution.  
<br><br>
You can use <b>Cutoff</b> to set a uniform length for all pads. With this you can record all samples into one melodic slot and copying it over to a drum slot. This will autoslice all samples into the 16 drum slots without issues. This can obviously cutoff samples and is inefficient when it comes to time used.

</div>
</body>
</html>
