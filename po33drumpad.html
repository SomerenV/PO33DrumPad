<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PO-33 Drum Pad</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ryanoasis/nerd-fonts@master/patched-fonts/3270/Regular/3270-Regular.css">

<style>
* { box-sizing:border-box; font-family:"3270 Nerd Font", monospace; }

body {
  background:#0d0d0d;
  color:#e0e0e0;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px;
}

h1 { font-size:48px; margin-bottom:12px; }

.buttons, .controls {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:center;
  margin-bottom:12px;
}

button {
  background:#111;
  color:#e0e0e0;
  border:1px solid #444;
  padding:8px 14px;
  font-size:15px;
  font-weight:bold;
  cursor:pointer;
}

button.selected {
  background:#fff;
  color:#000;
}

.grid {
  display:grid;
  grid-template-columns:repeat(4,200px);
  gap:10px;
  margin-bottom:16px;
}

.pad {
  width:200px;
  height:200px;
  background:#111;
  border:1px dashed #444;
  position:relative;
  cursor:pointer;
  overflow:hidden;
}

.pad.loaded { border-style:solid; background:#181818; }
.pad.playing { background:#00ff66; color:#000; }
.pad.countdown { background:#ff3333; color:#000; }

.pad-number {
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 14px;
  opacity: 0.5;
  pointer-events: none;
}

.pad {
  touch-action: manipulation;
}

.pad {
  touch-action: manipulation;
  user-select: none;
}

canvas {
  position:absolute;
  inset:0;
  opacity:0.25;
}

.rate {
  position:absolute;
  top:6px;
  left:6px;
  font-size:14px;
}

.label {
  position:absolute;
  bottom:6px;
  left:6px;
  right:6px;
  font-size:18px;
  white-space:pre-line;
  text-align:center;
}

input {
  background:#111;
  color:#fff;
  border:1px solid #444;
  font-size:18px;
  padding:4px 8px;
  width:90px;
  text-align:center;
}

.help {
  margin-top: 18px;
  max-width: 860px;
  opacity: 0.75;
  font-size: 20px;
}

.help ul {
  list-style: "• ";
  padding-left: 18px;
}

.help li {
  margin: 4px 0;
}

.help b {
  color: #fff;
  font-weight: bold;
}

</style>
</head>
<body>

<h1>PO-33 DRUM PAD</h1>

<div class="buttons" id="genreButtons"></div>
<div class="grid" id="grid"></div>

<div class="controls">
  <button id="playAll">Play All</button>
  <button id="play1">Play 1–8</button>
  <button id="play2">Play 9–16</button>
  <button id="stop">Stop</button>

  <label>Cutoff (ms)
    <input id="cutoffInput" type="number" value="0" min="0">
  </label>

  <label>Gap (ms)
    <input id="gapInput" type="number" value="50" min="0">
  </label>
</div>

<script>
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const grid = document.getElementById("grid");
const cutoffInput = document.getElementById("cutoffInput");
const gapInput = document.getElementById("gapInput");

const pads = [];
const rates = [1,2,3,4];

// ---- STOP CONTROL ----
let sequenceId = 0;
const activeSources = new Set();

// ---- GENRES ----
const layouts = {
  dnb:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","Kick","Kick Alt","Tom Low","Tom Mid","Tom High","Perc","Perc Alt","FX"],
  techno:["Crash","Ride","Open Hat","Noise","Closed Hat","Clap","Snare","Rim","Kick","Kick Sub","Kick Dist","Tom","Perc","Metal","FX","FX"],
  lofi:["Vinyl","Texture","Open Hat","FX","Soft Hat","Clap","Snare","Rim","Soft Kick","Low Kick","Tom","Tom","Perc","Shaker","Chord","Vocal"],
  jungle:["Crash","Ride","Open Hat","FX","Closed Hat","Snare","Ghost","Rim","Kick","Kick Alt","Tom Low","Tom Mid","Tom High","Amen","Perc","FX"],
  ambient:["Pad1","Pad2","Pad3","FX","Soft Hat","Bell","Snare","Rim","Kick","Kick Low","Tom","Tom","Texture","Texture","FX","FX"],
  trap:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","808","Kick Alt","Tom","Tom","Hi Tom","Perc","FX","Vocal"],
  breakbeat:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Alt Sn","Kick","Kick Alt","Tom","Tom","Hi Tom","Perc","FX","FX"],
  hiphop:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","Kick","Low Kick","Tom","Tom","Perc","Perc2","FX","Vocal"],
  house:["Crash","Ride","Open Hat","FX","Closed Hat","Clap","Snare","Rim","Kick","Sub","Alt Kick","Tom","Perc","Hi Tom","FX","FX"]
};

// ---- PAD CREATION ----
function createPad(i){
  const el=document.createElement("div");
  el.className="pad";

  const canvas=document.createElement("canvas");
  canvas.width=200; canvas.height=200;
  el.appendChild(canvas);

  const rateEl=document.createElement("div");
  rateEl.className="rate";
  el.appendChild(rateEl);
  
  const numEl = document.createElement("div");
numEl.className = "pad-number";
numEl.textContent = i + 1;
el.appendChild(numEl);

  const label=document.createElement("div");
  label.className="label";
  el.appendChild(label);

  grid.appendChild(el);

  pads[i]={buffer:null,duration:0,rate:1,el,canvas,rateEl,label,name:"",filename:""};

  el.ondragover=e=>e.preventDefault();
  el.ondrop=e=>{
    e.preventDefault();
    loadSample(e.dataTransfer.files[0],i);
  };

  el.oncontextmenu=e=>{
    e.preventDefault();
    cycleRate(i);
  };

if ("ontouchstart" in window) {
  addTouchControls(el, i);
} else {
  addMouseControls(el, i);
}


}

// ---- LONG PRESS ----
function addLongPress(el,i){
  let t=null;
  el.addEventListener("mousedown",()=>{
    t=setTimeout(()=>{
      if(navigator.vibrate) navigator.vibrate(40);
      openFile(i);
      t=null;
    },600);
  });
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(ev=>{
    el.addEventListener(ev,()=>{ if(t){clearTimeout(t); t=null;} });
  });
}

// ---- FILE ----
function openFile(i){
  const input=document.createElement("input");
  input.type="file"; input.accept="audio/*";
  input.onchange=e=>loadSample(e.target.files[0],i);
  input.click();
}

// ---- LOAD ----
async function loadSample(file,i){
  if(!file) return;
  const buf=await audioCtx.decodeAudioData(await file.arrayBuffer());
  const p=pads[i];
  p.buffer=buf;
  p.duration=buf.duration;
  p.filename=file.name.replace(/\..+$/,"");
  p.el.classList.add("loaded");
  drawWaveform(p);
  updateLabel(i);
  updateDuration();
}

// ---- WAVEFORM ----
function drawWaveform(p){
  const c=p.canvas;
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,200,200);
  const data=p.buffer.getChannelData(0);
  ctx.strokeStyle="#fff";
  ctx.beginPath();
  for(let x=0;x<200;x++){
    const i=Math.floor(x/data.length*data.length);
    const y=(1-data[i])*100;
    ctx.lineTo(x,y);
  }
  ctx.stroke();
}

// ---- LABEL ----
function updateLabel(i){
  const p=pads[i];
  p.rateEl.textContent=p.rate+"x";
  p.label.textContent=
    p.name +
    (p.buffer ? `\n${p.filename}\n${p.duration.toFixed(2)}s` : "");
}

// ---- RATE ----
function cycleRate(i){
  const p=pads[i];
  p.rate=rates[(rates.indexOf(p.rate)+1)%rates.length];
  updateLabel(i);
  updateDuration();
}

function addTouchControls(el, i){
  let lastTap = 0;
  let longPressTimer = null;
  let longPressTriggered = false;

  el.addEventListener("touchstart", e => {
    e.preventDefault(); // stops mouse synthesis
    longPressTriggered = false;

    longPressTimer = setTimeout(() => {
      longPressTriggered = true;
      if (navigator.vibrate) navigator.vibrate(40);
      openFile(i);
    }, 600);
  }, { passive: false });

  el.addEventListener("touchend", e => {
    e.preventDefault();
    clearTimeout(longPressTimer);

    if (longPressTriggered) return;

    const now = Date.now();
    if (now - lastTap < 300) {
      cycleRate(i);
      lastTap = 0;
    } else {
      lastTap = now;
      playPad(i);
    }
  }, { passive: false });
}

function addMouseControls(el, i){
  let longPressTimer = null;
  let longPressTriggered = false;

  el.addEventListener("mousedown", e => {
    if (e.button !== 0) return; // left mouse only
    longPressTriggered = false;

    longPressTimer = setTimeout(() => {
      longPressTriggered = true;
      openFile(i);
    }, 600);
  });

  el.addEventListener("mouseup", e => {
    clearTimeout(longPressTimer);
    if (longPressTriggered) return;
    playPad(i);
  });

  el.addEventListener("mouseleave", () => {
    clearTimeout(longPressTimer);
  });

  el.addEventListener("contextmenu", e => {
    e.preventDefault();
    cycleRate(i);
  });
}

// ---- PLAY PAD ----
function playPad(i){
  const p=pads[i];
  if(!p.buffer) return;

  const src=audioCtx.createBufferSource();
  src.buffer=p.buffer;
  src.playbackRate.value=p.rate;
  src.connect(audioCtx.destination);
  activeSources.add(src);

  const cutoff=+cutoffInput.value/1000;
  const dur=cutoff>0?Math.min(cutoff,p.buffer.duration/p.rate):p.buffer.duration/p.rate;

  src.start();
  src.stop(audioCtx.currentTime+dur);
  src.onended=()=>activeSources.delete(src);

  p.el.classList.add("playing");
  setTimeout(()=>p.el.classList.remove("playing"),100);
}

// ---- SEQUENCE ----
async function playRange(start,end){
  const mySeq=++sequenceId;
  const gap=+gapInput.value/1000;
  const cutoff=+cutoffInput.value/1000;

  for(let i=start;i<end;i++){
    if(mySeq!==sequenceId) return;
    const p=pads[i];
    if(!p.buffer) continue;

    for(let c=3;c>0;c--){
      if(mySeq!==sequenceId) return;
      p.el.classList.add("countdown");
      p.label.textContent=`${p.name}\n${c}`;
      await new Promise(r=>setTimeout(r,1000));
    }

    updateLabel(i);
    playPad(i);

    const dur=cutoff>0?Math.min(cutoff,p.buffer.duration/p.rate):p.buffer.duration/p.rate;
    await new Promise(r=>setTimeout(r,(dur+gap)*1000));
    p.el.classList.remove("countdown");
  }
}

// ---- DURATION ----
function updateDuration(){
  let t=0;
  const gap=+gapInput.value/1000;
  const cutoff=+cutoffInput.value/1000;
  pads.forEach(p=>{
    if(!p.buffer) return;
    const d=cutoff>0?Math.min(cutoff,p.buffer.duration/p.rate):p.buffer.duration/p.rate;
    t+=d+gap;
  });
  document.getElementById("playAll").textContent=`Play All (${t.toFixed(2)}s)`;
}

// ---- BUTTONS ----
document.getElementById("playAll").onclick=()=>playRange(0,16);
document.getElementById("play1").onclick=()=>playRange(0,8);
document.getElementById("play2").onclick=()=>playRange(8,16);

document.getElementById("stop").onclick=()=>{
  sequenceId++;
  activeSources.forEach(src=>{ try{src.stop();}catch{} });
  activeSources.clear();
  pads.forEach((p,i)=>{
    p.el.classList.remove("playing","countdown");
    updateLabel(i);
  });
};

cutoffInput.oninput=gapInput.oninput=updateDuration;

// ---- GENRES ----
const gb=document.getElementById("genreButtons");
Object.keys(layouts).forEach(g=>{
  const b=document.createElement("button");
  b.textContent=g.toUpperCase();
  b.onclick=()=>{
    gb.querySelectorAll("button").forEach(x=>x.classList.remove("selected"));
    b.classList.add("selected");
    layouts[g].forEach((n,i)=>{pads[i].name=n; updateLabel(i);});
  };
  gb.appendChild(b);
});

// ---- INIT ----
for(let i=0;i<16;i++) createPad(i);
gb.firstChild.click();
updateDuration();
</script>
<div class="help">
  <ul>
    <li><b>Tap</b> pad to play</li>
    <li><b>Long-press or drag & drop</b> pad to load a sample</li>
    <li><b>Right-click or double-tap</b> to change the playbackrate</li>
  </ul>
Use <b>Play All</b> to record the drum samples into a drum slot of the PO-33 (<i>Record + 9-15</i>) using transient detection. Use <b>Play 1-8</b> and <b>Play 9-16</b> if transient detection doesn't work for you. Start with <b>Play 1-8</b> and record them into the 8 melodic slots. Copy each slot to the corresponding drum slot (<i>Write + Sound + 9-16 + 1-8</i>). Then record 9-16 into the 8 melodic slots and copy them into the corresponding drum slot (<i>Write + Sound + 9-16 + 9-16</i>). This takes more effort but works flawlessly if depending on transient detection doesn't work.
<br><br>
You can speed up a sample to mittigate the 40 second limit of the PO-33. Pitch the sample down on the PO-33 to restore its speed. This will impact the quality so use with caution.  
<br><br>
You can use <b>Cutoff</b> to set a uniform length for all pads. With this you can record all samples into one melodic slot and copying it over to a drum slot. This will autoslice all samples into the 16 drum slots without issues. This can obviously cutoff samples and is inefficient when it comes to time used.

</div>
</body>
</html>
